# CloudFront + S3 静的サイトにおける WAF 不採用と、将来 API 公開時の防御方針

## 1. 背景
本ドキュメントは、個人開発における **S3 + CloudFront を用いた静的サイト配信**と、将来的に **API Gateway + Lambda + DynamoDB** で提供する軽量 API 公開を想定したセキュリティ設計方針を示すものである。目的は **最小コストで最大限のリスクをブロック**し、固定費の発生を抑えつつ安定運用を実現すること。

## 2. 現状構成と前提条件
- 静的コンテンツのみ（HTML, CSS, JS, 画像）
- CloudFront キャッシュ TTL: 30日（更新はCI/CDでキャッシュ無効化）
- **キャッシュキー設定**：`queryStringBehavior: none()`、`cookieBehavior: none()`、`headerBehavior: allowList("content-type")` により、クエリ文字列やCookieはキャッシュ判定に含めない設定
- このため、同一パスへのリクエストはクエリやCookieが異なっても同一キャッシュを返し、キャッシュHIT率はほぼ100%
- OAC (Origin Access Control) により S3 直アクセス禁止 ✅
- S3パブリックアクセスブロック有効 ✅
- 個人開発のため、月間アクセスは低〜中規模想定

## 3. 想定される攻撃と現状の防御状況
| 攻撃種別 | 発生頻度 | 被害内容 | 被害額の目安 | 現状の防御と理由 |
|----------|----------|----------|--------------|------------------|
| L3/L4 DDoS (大量TCP/UDP/HTTP) | 中 | サイト停止 | 0円 | ✅ CloudFront + Shield Standard により自動無料防御。さらにTTL30日設定とキャッシュキー設定により全リクエストがキャッシュHITし、Origin負荷をほぼゼロ化。WAF不要。 |
| L7 HTTPフラッド（大量GET） | 低〜中 | S3請求増 | 数円〜数百円/月 | ✅ キャッシュTTL30日＆キャッシュキー設定により、同一パスのリクエストはクエリやCookieが異なっても同じキャッシュを返すため、全てHIT。S3課金増は発生しない。 |
| スクレイピング | 中 | コンテンツコピー | 金銭的被害なし | 部分的にUAやrobots.txtで制御可能。WAFでの追加効果は限定的。 |
| 長大URI/ヘッダ送信 | 低 | ログ汚染 | 無視可能 | 静的サイトでは影響なし。 |
| 既知脆弱性攻撃ペイロード（XSS, SQLi等） | 低 | 影響なし（サーバー側処理なし） | 0円 | ✅ サーバー側処理がないため不発。 |
| 不正ファイルDL試行 | 中 | 存在せず404 | 0円 | ✅ OACとS3パブリックアクセスブロックにより直アクセス不可。 |

**検証結果**：本CDK設定では、クエリ文字列やCookieを変えてもキャッシュミスは発生せず、未キャッシュ時やキャッシュ無効化直後を除き全リクエストがHITするため、L7 HTTPフラッドによるS3課金増は事実上不可能。

## 4. 将来のAPI構成とリスク
- API Gateway（REST/HTTP）
- Lambda（スコア記録等の軽量処理）
- DynamoDB（スコア保存）

想定される主な攻撃：
| 攻撃種別 | 発生頻度 | 被害内容 | 被害額の目安 | 備考 |
|----------|----------|----------|--------------|------|
| BOTによる大量POST | 中〜高 | Lambda実行回数・DynamoDB書込課金増 | 数百〜数千円/月〜 | 無料枠超過リスク |
| 不正ペイロード | 低 | Lambdaエラー増、ログ汚染 | 軽微 | Lambdaでバリデーション可能 |
| 認証回避（不正スコア登録） | 中 | データ改ざん | 軽微〜中 | 認証/署名付きリクエストで防御可能 |

## 4.x API公開時の防御方針（低コスト・汎用）
本プロジェクトでは、**JS逆解析までやる本気勢は対象外**とし、**巡回Botの大量アクセス**と**curl等の単純な不正スコア送信**の遮断に主眼を置く。**固定費ゼロ〜極小**での運用を重視する。

### 方針概要
- ✅ **前段でブロック**：CloudFront **Viewer Request** で **CloudFront Functions** により**二段階トークン＋HMAC検証**。不正は **API Gateway到達前に403**。
- ✅ **全体レート制限**：API Gatewayの**ステージスロットリング**を厳しめに（例：2 rps / burst 5）。固定費ゼロ。
- ✅ **想定外は切り捨て**：JS逆解析／本気の署名再現は対象外（個人開発の範囲外）。

### 二段階トークン戦術（スコア登録防御）
1. **ゲーム開始時** `/get-start`：CloudFront Functionsが弱署名トークンT_start発行（時刻＋軽い秘密鍵でハッシュ）。
2. **ゲーム終了時** `/get-end`：T_startを検証し、終了トークンT_endを発行。
3. **スコア送信時** `/scores`：T_startとT_endの整合性、プレイ時間、HMAC署名（鍵=T_end）をCloudFront Functionsで検証し、OKのみAPI Gatewayへ。

この方式により、**curl等で直接スコア送信する単純攻撃は防止**可能。JSを実行する本気Botは対象外。

### スコア取得防御（ランキングAPIの大量取得対策）
- `/ranking/{gameId}/{day}/top10` はCloudFrontで長TTLキャッシュ（例：300〜1800秒）。
- スコア登録Lambdaでトップ10更新検知→変化があればCloudFrontの該当パスのみ無効化。
- 大量取得はすべてキャッシュHITとなり、API Gateway/Lambda/DynamoDB負荷や課金増を防止。

### 運用チェックリスト
- [ ] Functions秘密鍵はコードに直接埋め込まず、KVS等で管理
- [ ] トークンTTLや猶予時間の設定
- [ ] ランキング無効化の対象パス管理
- [ ] API Gatewayスロットリング設定（例：2 rps / burst 5）

### コスト概算
- **CloudFront Functions**：軽処理＆無料枠で$0〜$1/月
- **API Gateway**：標準課金のみ（スロットリング設定は無料）
- **WAF**：現時点は導入不要（固定$5+が見合わない）

### 既知の限界
- 本気のJS逆解析・署名再現は理論上可能（対象外）
- "本当にプレイして獲得したスコアか"の証明はしない

## 5. 不正スコア登録の防御方法（参考）
- **ユーザー認証**（Cognito等）による本人確認
- **署名付きリクエスト**（AWS SigV4, JWTなど）で改ざん防止
- **CloudFront経由のみ許可**し、カスタムヘッダで検証
- **レート制限**でBOTによる連続登録防止
- **DynamoDB条件付き書き込み**で重複や矛盾データを防止

## 6. 採用しない判断の根拠
1. 静的サイト時点でのWAF費用は被害額を上回る
2. API公開時も初期はAPI Gatewayの無料機能で十分防御可能
3. SQLインジェクション等はアプリ側で防御可能
4. 必要時のみ追加投資できる柔軟性

## 7. まとめ
- **現状**：CloudFront + S3 静的サイトはWAF不要。TTL30日＋クエリ/Cookie無視のキャッシュキー設定＋OAC＋S3パブリックアクセスブロックで十分防御可能。
- **将来**：API公開時はCloudFront Functionsでの二段階トークン検証＋API Gatewayの全体レート制限で固定費ゼロを維持。
- **方針**：最小コストで最大リスクをブロックし、必要時のみ追加投資する段階的戦略。

---
*本方針は個人開発のコスト最適化とリスク低減の両立を目的とする。商用・高負荷環境では早期のWAF導入が推奨される。*